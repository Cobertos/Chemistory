"use strict";void 0===THREE.LoaderSupport&&(THREE.LoaderSupport={}),THREE.LoaderSupport.Validator={isValid:function(e){return null!=e},verifyInput:function(e,r){return null==e?r:e}},THREE.LoaderSupport.Callbacks=function(){var r=THREE.LoaderSupport.Validator;function e(){this.onProgress=null,this.onReportError=null,this.onMeshAlter=null,this.onLoad=null,this.onLoadMaterials=null}return e.prototype.setCallbackOnProgress=function(e){this.onProgress=r.verifyInput(e,this.onProgress)},e.prototype.setCallbackOnReportError=function(e){this.onReportError=r.verifyInput(e,this.onReportError)},e.prototype.setCallbackOnMeshAlter=function(e){this.onMeshAlter=r.verifyInput(e,this.onMeshAlter)},e.prototype.setCallbackOnLoad=function(e){this.onLoad=r.verifyInput(e,this.onLoad)},e.prototype.setCallbackOnLoadMaterials=function(e){this.onLoadMaterials=r.verifyInput(e,this.onLoadMaterials)},e}(),THREE.LoaderSupport.LoadedMeshUserOverride=function(){function e(e,r){this.disregardMesh=!0===e,this.alteredMesh=!0===r,this.meshes=[]}return e.prototype.addMesh=function(e){this.meshes.push(e),this.alteredMesh=!0},e.prototype.isDisregardMesh=function(){return this.disregardMesh},e.prototype.providesAlteredMeshes=function(){return this.alteredMesh},e}(),THREE.LoaderSupport.ResourceDescriptor=function(){var o=THREE.LoaderSupport.Validator;function e(e,r){var t=e.split("/");t.length<2?(this.path=null,this.name=e):(this.path=o.verifyInput(t.slice(0,t.length-1).join("/")+"/",null),this.name=t[t.length-1]),this.url=e,this.name=o.verifyInput(this.name,"Unnamed_Resource"),this.extension=o.verifyInput(r,"default"),this.extension=this.extension.trim(),this.content=null}return e.prototype.setContent=function(e){this.content=o.verifyInput(e,null)},e}(),THREE.LoaderSupport.PrepData=function(){var u=THREE.LoaderSupport.Validator;function e(e){this.logging={enabled:!0,debug:!1},this.modelName=u.verifyInput(e,""),this.resources=[],this.callbacks=new THREE.LoaderSupport.Callbacks}return e.prototype.setLogging=function(e,r){this.logging.enabled=!0===e,this.logging.debug=!0===r},e.prototype.getCallbacks=function(){return this.callbacks},e.prototype.addResource=function(e){this.resources.push(e)},e.prototype.clone=function(){var e,r,t=new THREE.LoaderSupport.PrepData(this.modelName);for(e in t.logging.enabled=this.logging.enabled,t.logging.debug=this.logging.debug,t.resources=this.resources,t.callbacks=this.callbacks,this)r=this[e],t.hasOwnProperty(e)||"function"==typeof this[e]||(t[e]=r);return t},e.prototype.checkResourceDescriptorFiles=function(e,r){var t,o,n,i,s={};for(var a in e)if(t=e[a],i=!1,u.isValid(t.name))if(u.isValid(t.content)){for(n=0;n<r.length&&!i;n++)if(o=r[n],t.extension.toLowerCase()===o.ext.toLowerCase())if(o.ignore)i=!0;else if("ArrayBuffer"===o.type){if(!(t.content instanceof ArrayBuffer||t.content instanceof Uint8Array))throw"Provided content is not of type ArrayBuffer! Aborting...";s[o.ext]=t,i=!0}else if("String"===o.type){if(!("string"==typeof t.content||t.content instanceof String))throw"Provided  content is not of type String! Aborting...";s[o.ext]=t,i=!0}if(!i)throw'Unidentified resource "'+t.name+'": '+t.url}else{if(!("string"==typeof t.name||t.name instanceof String))throw"Provided file is not properly defined! Aborting...";for(n=0;n<r.length&&!i;n++)o=r[n],t.extension.toLowerCase()===o.ext.toLowerCase()&&(o.ignore||(s[o.ext]=t),i=!0);if(!i)throw'Unidentified resource "'+t.name+'": '+t.url}return s},e}(),THREE.LoaderSupport.WorkerRunnerRefImpl=function(){function e(){this.getParentScope().addEventListener("message",function(e){this.processMessage(e.data)}.bind(this))}return e.prototype.getParentScope=function(){return self},e.prototype.applyProperties=function(e,r){var t,o,n;for(t in r)o="set"+t.substring(0,1).toLocaleUpperCase()+t.substring(1),n=r[t],"function"==typeof e[o]?e[o](n):e.hasOwnProperty(t)&&(e[t]=n)},e.prototype.processMessage=function(r){if("run"===r.cmd){var t=this.getParentScope(),e={callbackMeshBuilder:function(e){t.postMessage(e)},callbackProgress:function(e){r.logging.enabled&&r.logging.debug&&console.debug("WorkerRunner: progress: "+e)}},o=new Parser;"function"==typeof o.setLogging&&o.setLogging(r.logging.enabled,r.logging.debug),this.applyProperties(o,r.params),this.applyProperties(o,r.materials),this.applyProperties(o,e),o.workerScope=t,o.parse(r.data.input,r.data.options),r.logging.enabled&&console.log("WorkerRunner: Run complete!"),e.callbackMeshBuilder({cmd:"complete",msg:"WorkerRunner completed run."})}else console.error("WorkerRunner: Received unknown command: "+r.cmd)},e}(),THREE.LoaderSupport.WorkerSupport=function(){var WORKER_SUPPORT_VERSION="2.2.1",Validator=THREE.LoaderSupport.Validator,LoaderWorker=function(){function n(){this._reset()}return n.checkSupport=function(){return void 0===window.Worker?"This browser does not support web workers!":void 0===window.Blob?"This browser does not support Blob!":"function"!=typeof window.URL.createObjectURL?"This browser does not support Object creation from URL!":void 0},n.prototype._reset=function(){this.logging={enabled:!0,debug:!1},this.worker=null,this.runnerImplName=null,this.callbacks={meshBuilder:null,onLoad:null},this.terminateRequested=!1,this.queuedMessage=null,this.started=!1,this.forceCopy=!1},n.prototype.setLogging=function(e,r){this.logging.enabled=!0===e,this.logging.debug=!0===r},n.prototype.setForceCopy=function(e){this.forceCopy=!0===e},n.prototype.initWorker=function(e,r){var t=n.checkSupport();if(t)throw t;this.runnerImplName=r;var o=new Blob([e],{type:"application/javascript"});this.worker=new Worker(window.URL.createObjectURL(o)),this.worker.onmessage=this._receiveWorkerMessage,(this.worker.runtimeRef=this)._postMessage()},n.prototype._receiveWorkerMessage=function(e){var r=e.data;switch(r.cmd){case"meshData":case"materialData":case"imageData":this.runtimeRef.callbacks.meshBuilder(r);break;case"complete":this.runtimeRef.queuedMessage=null,this.started=!1,this.runtimeRef.callbacks.onLoad(r.msg),this.runtimeRef.terminateRequested&&(this.runtimeRef.logging.enabled&&console.info("WorkerSupport ["+this.runtimeRef.runnerImplName+"]: Run is complete. Terminating application on request!"),this.runtimeRef._terminate());break;case"error":console.error("WorkerSupport ["+this.runtimeRef.runnerImplName+"]: Reported error: "+r.msg),this.runtimeRef.queuedMessage=null,this.started=!1,this.runtimeRef.callbacks.onLoad(r.msg),this.runtimeRef.terminateRequested&&(this.runtimeRef.logging.enabled&&console.info("WorkerSupport ["+this.runtimeRef.runnerImplName+"]: Run reported error. Terminating application on request!"),this.runtimeRef._terminate());break;default:console.error("WorkerSupport ["+this.runtimeRef.runnerImplName+"]: Received unknown command: "+r.cmd)}},n.prototype.setCallbacks=function(e,r){this.callbacks.meshBuilder=Validator.verifyInput(e,this.callbacks.meshBuilder),this.callbacks.onLoad=Validator.verifyInput(r,this.callbacks.onLoad)},n.prototype.run=function(e){if(Validator.isValid(this.queuedMessage))console.warn("Already processing message. Rejecting new run instruction");else{if(this.queuedMessage=e,this.started=!0,!Validator.isValid(this.callbacks.meshBuilder))throw'Unable to run as no "MeshBuilder" callback is set.';if(!Validator.isValid(this.callbacks.onLoad))throw'Unable to run as no "onLoad" callback is set.';"run"!==e.cmd&&(e.cmd="run"),Validator.isValid(e.logging)?(e.logging.enabled=!0===e.logging.enabled,e.logging.debug=!0===e.logging.debug):e.logging={enabled:!0,debug:!1},this._postMessage()}},n.prototype._postMessage=function(){var e;Validator.isValid(this.queuedMessage)&&Validator.isValid(this.worker)&&(this.queuedMessage.data.input instanceof ArrayBuffer?(e=this.forceCopy?this.queuedMessage.data.input.slice(0):this.queuedMessage.data.input,this.worker.postMessage(this.queuedMessage,[e])):this.worker.postMessage(this.queuedMessage))},n.prototype.setTerminateRequested=function(e){this.terminateRequested=!0===e,this.terminateRequested&&Validator.isValid(this.worker)&&!Validator.isValid(this.queuedMessage)&&this.started&&(this.logging.enabled&&console.info("Worker is terminated immediately as it is not running!"),this._terminate())},n.prototype._terminate=function(){this.worker.terminate(),this._reset()},n}(),NodeLoaderWorker=function(){function NodeLoaderWorker(){LoaderWorker.call(this)}return Object.setPrototypeOf(NodeLoaderWorker.prototype,LoaderWorker.prototype),NodeLoaderWorker.checkSupport=function(){try{var _require=eval("require");_require.resolve("worker_threads")}catch(e){return"This version of Node does not support web workers!"}},NodeLoaderWorker.prototype.initWorker=function(code,runnerImplName){var supportError=NodeLoaderWorker.checkSupport();if(supportError)throw supportError;this.runnerImplName=runnerImplName;var _require=eval("require"),Worker=_require("worker_threads").Worker;this.worker=new Worker(code,{eval:!0}),this.worker.onmessage=this._receiveWorkerMessage,this.worker.runtimeRef=this,this._postMessage()},NodeLoaderWorker}();function WorkerSupport(){console.info("Using THREE.LoaderSupport.WorkerSupport version: "+WORKER_SUPPORT_VERSION),this.logging={enabled:!0,debug:!1},this.loaderWorker="undefined"!=typeof window?new LoaderWorker:new NodeLoaderWorker}WorkerSupport.prototype.setLogging=function(e,r){this.logging.enabled=!0===e,this.logging.debug=!0===r,this.loaderWorker.setLogging(this.logging.enabled,this.logging.debug)},WorkerSupport.prototype.setForceWorkerDataCopy=function(e){this.loaderWorker.setForceCopy(e)},WorkerSupport.prototype.validate=function(e,r,t,o,n){if(!Validator.isValid(this.loaderWorker.worker)){this.logging.enabled&&(console.info("WorkerSupport: Building worker code..."),console.time("buildWebWorkerCode")),Validator.isValid(n)?this.logging.enabled&&console.info('WorkerSupport: Using "'+n.name+'" as Runner class for worker.'):"undefined"!=typeof window?(n=THREE.LoaderSupport.WorkerRunnerRefImpl,this.logging.enabled&&console.info('WorkerSupport: Using DEFAULT "THREE.LoaderSupport.WorkerRunnerRefImpl" as Runner class for worker.')):(n=THREE.LoaderSupport.NodeWorkerRunnerRefImpl,this.logging.enabled&&console.info('WorkerSupport: Using DEFAULT "THREE.LoaderSupport.NodeWorkerRunnerRefImpl" as Runner class for worker.'));var i=e(buildObject,buildSingleton);i+="var Parser = "+r+";\n\n",i+=buildSingleton(n.name,n),i+="new "+n.name+"();\n\n";var s=this;if(Validator.isValid(t)&&0<t.length){var a="",u=function(r,t){if(0===t.length)s.loaderWorker.initWorker(a+i,n.name),s.logging.enabled&&console.timeEnd("buildWebWorkerCode");else{var e=new THREE.FileLoader;e.setPath(r),e.setResponseType("text"),e.load(t[0],function(e){a+=e,u(r,t)}),t.shift()}};u(o,t)}else this.loaderWorker.initWorker(i,n.name),this.logging.enabled&&console.timeEnd("buildWebWorkerCode")}},WorkerSupport.prototype.setCallbacks=function(e,r){this.loaderWorker.setCallbacks(e,r)},WorkerSupport.prototype.run=function(e){this.loaderWorker.run(e)},WorkerSupport.prototype.setTerminateRequested=function(e){this.loaderWorker.setTerminateRequested(e)};var buildObject=function(e,r){var t,o=e+" = {\n";for(var n in r)"string"==typeof(t=r[n])||t instanceof String?o+="\t"+n+': "'+(t=(t=t.replace("\n","\\n")).replace("\r","\\r"))+'",\n':t instanceof Array?o+="\t"+n+": ["+t+"],\n":Number.isInteger(t)?o+="\t"+n+": "+t+",\n":"function"==typeof t&&(o+="\t"+n+": "+t+",\n");return o+="}\n\n"},buildSingleton=function(e,r,t,o,n){var i,s,a="",u=Validator.isValid(t)?t:r.name;for(var l in n=Validator.verifyInput(n,[]),r.prototype)i=r.prototype[l],"constructor"===l?s="\tfunction "+u+i.toString().replace("function","")+";\n\n":"function"==typeof i&&n.indexOf(l)<0&&(a+="\t"+u+".prototype."+l+" = "+i.toString()+";\n\n");a+="\treturn "+u+";\n",a+="})();\n\n";var p="";return Validator.isValid(o)&&(p+="\n",p+=u+".prototype = Object.create( "+o+".prototype );\n",p+=u+".constructor = "+u+";\n",p+="\n"),a=Validator.isValid(s)?e+" = (function () {\n\n"+p+s+a:(s=e+" = (function () {\n\n",(s+=p+"\t"+r.prototype.constructor.toString()+"\n\n")+a)};return WorkerSupport}(),THREE.LoaderSupport.NodeWorkerRunnerRefImpl=function(){function NodeWorkerRunnerRefImpl(){this.getParentScope().onmessage=this.processMessage.bind(this)}return Object.setPrototypeOf(NodeWorkerRunnerRefImpl.prototype,THREE.LoaderSupport.WorkerRunnerRefImpl.prototype),NodeWorkerRunnerRefImpl.prototype.getParentScope=function(){var _require=eval("require");return _require("worker_threads").parentPort},NodeWorkerRunnerRefImpl}(),THREE.LoaderSupport.WorkerDirector=function(){var s=THREE.LoaderSupport.Validator;function e(e){if(console.info("Using THREE.LoaderSupport.WorkerDirector version: 2.2.2"),this.logging={enabled:!0,debug:!1},this.maxQueueSize=8192,this.maxWebWorkers=16,this.crossOrigin=null,!s.isValid(e))throw"Provided invalid classDef: "+e;this.workerDescription={classDef:e,globalCallbacks:{},workerSupports:{},forceWorkerDataCopy:!0},this.objectsCompleted=0,this.instructionQueue=[],this.instructionQueuePointer=0,this.callbackOnFinishedProcessing=null}return e.prototype.setLogging=function(e,r){this.logging.enabled=!0===e,this.logging.debug=!0===r},e.prototype.getMaxQueueSize=function(){return this.maxQueueSize},e.prototype.getMaxWebWorkers=function(){return this.maxWebWorkers},e.prototype.setCrossOrigin=function(e){this.crossOrigin=e},e.prototype.setForceWorkerDataCopy=function(e){this.workerDescription.forceWorkerDataCopy=!0===e},e.prototype.prepareWorkers=function(e,r,t){s.isValid(e)&&(this.workerDescription.globalCallbacks=e),this.maxQueueSize=Math.min(r,8192),this.maxWebWorkers=Math.min(t,16),this.maxWebWorkers=Math.min(this.maxWebWorkers,this.maxQueueSize),this.objectsCompleted=0,this.instructionQueue=[];for(var o=this.instructionQueuePointer=0;o<this.maxWebWorkers;o++){var n=new THREE.LoaderSupport.WorkerSupport;n.setLogging(this.logging.enabled,this.logging.debug),n.setForceWorkerDataCopy(this.workerDescription.forceWorkerDataCopy),this.workerDescription.workerSupports[o]={instanceNo:o,inUse:!1,terminateRequested:!1,workerSupport:n,loader:null}}},e.prototype.enqueueForRun=function(e){this.instructionQueue.length<this.maxQueueSize&&this.instructionQueue.push(e)},e.prototype.isRunning=function(){var e=Object.keys(this.workerDescription.workerSupports);return 0<this.instructionQueue.length&&this.instructionQueuePointer<this.instructionQueue.length||0<e.length},e.prototype.processQueue=function(){var e,r;for(var t in this.workerDescription.workerSupports)(r=this.workerDescription.workerSupports[t]).inUse||(this.instructionQueuePointer<this.instructionQueue.length?(e=this.instructionQueue[this.instructionQueuePointer],this._kickWorkerRun(e,r),this.instructionQueuePointer++):this._deregister(r));this.isRunning()||null===this.callbackOnFinishedProcessing||(this.callbackOnFinishedProcessing(),this.callbackOnFinishedProcessing=null)},e.prototype._kickWorkerRun=function(e,t){t.inUse=!0,t.workerSupport.setTerminateRequested(t.terminateRequested),this.logging.enabled&&console.info("\nAssigning next item from queue to worker (queue length: "+this.instructionQueue.length+")\n\n");var o=this,n=e.getCallbacks(),i=this.workerDescription.globalCallbacks;t.loader=this._buildLoader(t.instanceNo);var r=new THREE.LoaderSupport.Callbacks;r.setCallbackOnLoad(function(e){s.isValid(i.onLoad)&&i.onLoad(e),s.isValid(n.onLoad)&&n.onLoad(e),o.objectsCompleted++,t.inUse=!1,o.processQueue()}),r.setCallbackOnProgress(function(e){s.isValid(i.onProgress)&&i.onProgress(e),s.isValid(n.onProgress)&&n.onProgress(e)}),r.setCallbackOnReportError(function(e){var r=!0;s.isValid(i.onReportError)&&(r=i.onReportError(t,e)),s.isValid(n.onReportError)&&(r=n.onReportError(t,e)),s.isValid(i.onReportError)||s.isValid(n.onReportError)||(console.error("Loader reported an error: "),console.error(e)),r&&(t.inUse=!1,o.processQueue())}),r.setCallbackOnMeshAlter(function(e,r){return s.isValid(i.onMeshAlter)&&(r=i.onMeshAlter(e,r)),s.isValid(n.onMeshAlter)&&(r=i.onMeshAlter(e,r)),r}),r.setCallbackOnLoadMaterials(function(e){return s.isValid(i.onLoadMaterials)&&(e=i.onLoadMaterials(e)),s.isValid(n.onLoadMaterials)&&(e=n.onLoadMaterials(e)),e}),e.callbacks=r,t.loader.run(e,t.workerSupport)},e.prototype._buildLoader=function(e){var r=this.workerDescription.classDef,t=Object.create(r.prototype);if(r.call(t,THREE.DefaultLoadingManager),!t.hasOwnProperty("instanceNo"))throw r.name+' has no property "instanceNo".';if(t.instanceNo=e,!t.hasOwnProperty("workerSupport"))throw r.name+' has no property "workerSupport".';if("function"!=typeof t.run)throw r.name+' has no function "run".';return t.hasOwnProperty("callbacks")&&s.isValid(t.callbacks)||(console.warn(r.name+' has an invalid property "callbacks". Will change to "THREE.LoaderSupport.Callbacks"'),t.callbacks=new THREE.LoaderSupport.Callbacks),t},e.prototype._deregister=function(e){if(s.isValid(e)){e.workerSupport.setTerminateRequested(!0),this.logging.enabled&&console.info("Requested termination of worker #"+e.instanceNo+".");var r=e.loader.callbacks;s.isValid(r.onProgress)&&r.onProgress({detail:{text:""}}),delete this.workerDescription.workerSupports[e.instanceNo]}},e.prototype.tearDown=function(e){for(var r in this.logging.enabled&&console.info("WorkerDirector received the deregister call. Terminating all workers!"),this.instructionQueuePointer=this.instructionQueue.length,this.callbackOnFinishedProcessing=s.verifyInput(e,null),this.workerDescription.workerSupports)this.workerDescription.workerSupports[r].terminateRequested=!0},e}();